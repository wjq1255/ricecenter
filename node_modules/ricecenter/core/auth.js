/**
 * Created by Administrator on 2015/6/3.
 */

var querystring = require('querystring');
var sortKeys = require('sort-keys');
var crypto = require('./cryptoUtils');

var CRYPTO_SALT = "www.anzhuoshangdian.com";

exports = module.exports = function auth(){
    return function auth(req, res, next) {

        if(req.method == 'POST')
        {
            next();
            return;
        }

        var sign = req.query.sign;
        if (!sign) {
            res.sendStatus(401);
            res.end();
            return;
        }

        var originalQs = req.originalUrl.split("?")[1];
        var queries = querystring.parse(originalQs);
        delete queries.sign;
        var authQs = querystring.stringify(sortKeys(queries));
        var digest = crypto.md5(authQs + CRYPTO_SALT);
        if (sign !== digest) {
            res.sendStatus(401);
            res.end();
            return;
        }

        next();
    };
};